version: 2.1

parameters:
  create_release_pr:
    type: boolean
    default: false

orbs:
  nx: nrwl/nx@1.7.0
  node: circleci/node@7.1.0
  github-cli: circleci/github-cli@2.7.1

commands:
  restore-nx-cache:
    description: "Restore Nx cache with enhanced fallback"
    steps:
      - restore_cache:
          name: Restore Nx Cache
          keys:
            - nx-cache-v1-{{ checksum "pnpm-lock.yaml" }}-{{ checksum "nx.json" }}
            - nx-cache-v1-{{ checksum "pnpm-lock.yaml" }}
            - nx-cache-v1-

  setup-nx:
    description: "Set up Nx SHAs for affected detection"
    steps:
      - nx/set-shas:
          main-branch-name: develop
          allow-on-hold-workflow: true
          error-on-no-successful-workflow: true
          workflow-name: "CI/CD"

  save-nx-cache:
    description: "Save Nx cache with revision-specific key"
    steps:
      - save_cache:
          name: Save Nx Cache
          key: nx-cache-v1-{{ checksum "pnpm-lock.yaml" }}-{{ checksum "nx.json" }}
          paths:
            - .nx/cache
            - node_modules/.cache/nx

  restore-vercel-cache:
    description: "Restore Vercel build cache"
    steps:
      - restore_cache:
          name: Restore Vercel Cache
          keys:
            - vercel-cache-v1-{{ checksum "pnpm-lock.yaml" }}-{{ checksum "apps/web/next.config.ts" }}
            - vercel-cache-v1-{{ checksum "pnpm-lock.yaml" }}
            - vercel-cache-v1-

  save-vercel-cache:
    description: "Save Vercel build cache"
    steps:
      - save_cache:
          name: Save Vercel Cache
          key: vercel-cache-v1-{{ checksum "pnpm-lock.yaml" }}-{{ checksum "apps/web/next.config.ts" }}
          paths:
            - .vercel
            - .next/cache

  setup:
    description: "Common setup steps for all jobs"
    steps:
      - node/install-pnpm:
          version: 10.12.4

      - node/install-packages:
          pkg-manager: pnpm
          cache-path: "~/.pnpm-store"
          with-cache: true

jobs:
  check:
    docker:
      - image: cimg/node:24.3.0
    resource_class: medium
    steps:
      - checkout
      - setup
      - setup-nx
      - restore-nx-cache
      - run:
          name: Run affected tasks
          command: |
            if pnpm exec nx show projects --affected --base=$NX_BASE  | wc -l | grep -q "^0$"; then
              echo "✅ No affected projects found, skipping lint and typecheck"
              exit 0
            fi
            pnpm exec nx affected --base=$NX_BASE -t lint:ci,typecheck
      - save-nx-cache

  test:
    docker:
      - image: cimg/node:24.3.0
    resource_class: large
    parallelism: 4
    steps:
      - checkout
      - setup
      - setup-nx
      - restore-nx-cache
      - run:
          name: Run affected tests in parallel
          command: |
            if pnpm exec nx show projects --affected --base=$NX_BASE --with-target=test | wc -l | grep -q "^0$"; then
              echo "✅ No affected projects with tests found, skipping"
              exit 0
            fi
            pnpm exec nx affected --base=$NX_BASE \
              --target=test --parallel
      - save-nx-cache
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: junit

  e2e:
    docker:
      - image: mcr.microsoft.com/playwright:v1.53.2-noble
    resource_class: large
    parallelism: 2
    steps:
      - checkout
      - setup
      - setup-nx
      - restore-nx-cache
      - run:
          name: Run affected e2e tests
          command: |
            if pnpm exec nx show projects --affected --base=$NX_BASE --with-target=e2e | wc -l | grep -q "^0$"; then
              echo "✅ No affected projects with e2e tests found, skipping"
              exit 0
            fi
            pnpm exec nx affected --base=$NX_BASE --target=e2e --parallel
      - save-nx-cache
      - store_test_results:
          path: dist/apps/web-e2e/junit.xml
      - store_artifacts:
          path: dist/apps/web-e2e/html-report
          destination: playwright-report

  chromatic:
    docker:
      - image: cimg/node:24.3.0
    resource_class: medium
    environment:
      CI: true
    steps:
      - checkout
      - setup
      - setup-nx
      - restore-nx-cache
      - run:
          name: Run Chromatic
          command: cd libs/ui && npx chromatic
      - save-nx-cache

  deploy-preview:
    docker:
      - image: cimg/node:24.3.0
    resource_class: large
    steps:
      - checkout
      - setup
      - restore-vercel-cache
      - run:
          name: Pull Vercel Environment Information
          command: npx vercel@latest pull --yes --environment=preview --token=$VERCEL_TOKEN
      - run:
          name: Build Project
          command: npx vercel@latest build --token=$VERCEL_TOKEN
      - run:
          name: Deploy Project Artifacts to Vercel
          command: |
            VERCEL_URL=$(npx vercel@latest deploy --token=$VERCEL_TOKEN)
            if [[ ! "$VERCEL_URL" =~ ^https?:// ]]; then
              echo "Invalid Vercel URL received: $VERCEL_URL"
              exit 1
            fi
            echo "export VERCEL_URL=$VERCEL_URL" >> $BASH_ENV
      - github-cli/install
      - run:
          name: Create GitHub Deployment
          command: |
            source $BASH_ENV
            if [ -n "$GITHUB_TOKEN" ]; then
              DEPLOYMENT_ID=$(gh api repos/{owner}/{repo}/deployments \
                --method POST \
                --input - <<< '{
                  "ref": "'${CIRCLE_SHA1}'",
                  "environment": "preview",
                  "description": "Preview deployment for '${CIRCLE_SHA1:0:7}'",
                  "required_contexts": []
                }' \
                --jq '.id')

              gh api repos/{owner}/{repo}/deployments/${DEPLOYMENT_ID}/statuses \
                --method POST \
                -f state="success" \
                -f environment_url="${VERCEL_URL}" \
                -f description="Preview deployment ready" \
                -f log_url="${CIRCLE_BUILD_URL}"

              gh api repos/{owner}/{repo}/statuses/${CIRCLE_SHA1} \
                --method POST \
                -f state="success" \
                -f target_url="${VERCEL_URL}" \
                -f description="Preview ready" \
                -f context="deploy/preview"

              echo "✅ GitHub deployment created: ${VERCEL_URL}"
            else
              echo "⚠️ GITHUB_TOKEN not set, skipping GitHub integration"
            fi

  deploy-production:
    docker:
      - image: cimg/node:24.3.0
    resource_class: medium
    steps:
      - checkout
      - setup
      - restore-vercel-cache
      - run:
          name: Plan production deployment
          command: |
            if ! circleci run release plan --target-version=production-$CIRCLE_SHA1 --environment-name=production --component-name=dex-web; then
              echo "Failed to plan release"
              exit 1
            fi
      - run:
          name: Update deployment status to running
          command: |
            if ! circleci run release update --status=running; then
              echo "Failed to update deployment status to running"
              exit 1
            fi
      - run:
          name: Pull Vercel Environment Information
          command: npx vercel@latest pull --yes --environment=production --token=$VERCEL_TOKEN
      - run:
          name: Build Project
          command: npx vercel@latest build --prod --token=$VERCEL_TOKEN
      - run:
          name: Deploy Project Artifacts to Vercel
          command: |
            PRODUCTION_URL=$(npx vercel@latest deploy --prod --token=$VERCEL_TOKEN)
            echo "export PRODUCTION_URL=$PRODUCTION_URL" >> $BASH_ENV
      - github-cli/install
      - run:
          name: Create GitHub Production Deployment
          command: |
            source $BASH_ENV
            if [ -n "$GITHUB_TOKEN" ]; then
              DEPLOYMENT_ID=$(gh api repos/{owner}/{repo}/deployments \
                --method POST \
                --input - <<< '{
                  "ref": "'${CIRCLE_SHA1}'",
                  "environment": "production",
                  "description": "Production deployment '${CIRCLE_TAG:-${CIRCLE_SHA1:0:7}}'",
                  "production_environment": true,
                  "required_contexts": []
                }' \
                --jq '.id')

              gh api repos/{owner}/{repo}/deployments/${DEPLOYMENT_ID}/statuses \
                --method POST \
                -f state="success" \
                -f environment_url="${PRODUCTION_URL:-https://darklake.fi}" \
                -f description="Production deployment successful" \
                -f log_url="${CIRCLE_BUILD_URL}"

              gh api repos/{owner}/{repo}/statuses/${CIRCLE_SHA1} \
                --method POST \
                -f state="success" \
                -f target_url="${PRODUCTION_URL:-https://darklake.fi}" \
                -f description="Deployed to production" \
                -f context="deploy/production"

              echo "✅ GitHub production deployment created: ${PRODUCTION_URL:-https://darklake.fi}"
            else
              echo "⚠️ GITHUB_TOKEN not set, skipping GitHub integration"
            fi
      - run:
          name: Update deployment status to SUCCESS
          command: circleci run release update --status=SUCCESS
          when: on_success
      - run:
          name: Update deployment status to FAILED
          command: circleci run release update --status=FAILED
          when: on_fail
      - save-vercel-cache

  create_release_pull_request:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - github-cli/install
      - run:
          name: Create Release Pull Request
          command: |
            REVIEWERS="darklakefi/release"
            gh auth login --with-token <<< "$GITHUB_TOKEN"
            EXISTING_PR=$(gh pr list --base main --head develop --json number -q '.[0].number')
            if [ -n "$EXISTING_PR" ]; then
              echo "Pull request from develop to main already exists: #$EXISTING_PR"
              exit 0
            fi
            git fetch origin main
            git fetch origin develop
            CHANGELOG=$(git log origin/main..origin/develop --oneline --pretty=format:'- %s (%h)' --no-merges)
            if [ -z "$CHANGELOG" ]; then
              echo "No changes between develop and main. No PR created."
              exit 0
            fi
            PR_BODY=$(cat <<EOF
            Automated release pull request.
            ## Changes
            $CHANGELOG
            EOF
            )
            gh pr create \
              --base "main" \
              --head "develop" \
              --title "chore(release): Sync develop to main" \
              --body "$PR_BODY" \
              --reviewer "$REVIEWERS"

workflows:
  ci-cd:
    jobs:
      - check
      - test
      - chromatic:
          requires:
            - check
            - test
      - e2e:
          context:
            - darklakefi-development
          requires:
            - check
            - test
      - deploy-preview:
          context:
            - darklakefi-deployments
            - darklakefi-development
          requires:
            - check
            - test
          filters:
            branches:
              ignore: /main/
      - deploy-production:
          context:
            - darklakefi-deployments
            - darklakefi-production
          requires:
            - check
            - test
            - e2e
          filters:
            branches:
              only: /main/

  release-pr:
    when: << pipeline.parameters.create_release_pr >>
    jobs:
      - create_release_pull_request:
          context:
            - darklakefi-deployments
